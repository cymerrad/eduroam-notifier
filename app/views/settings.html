<div class="container">
    {{if .settings}}

    <h2>Settings:</h2>
        {{if .settings.Templates}}
            {{range .settings.Templates}}
    <div class="form-group">
        <label for="template{{.ID}}">Template message <b>ID:{{.ID}}</b></label>
        <textarea name="template{{.ID}}" class="form-control" rows="10" id="template{{.ID}}"></textarea>
    </div> 

    <script>
        $('#template{{.ID}}').val("{{.Body}}");
    </script>  
            {{end}}
        {{end}}

        {{if .settings.Rules}}
    <div class="form-group">
    <label for="cases">On/Do cases:</label>
    <table class="table table-hover" id="cases">
        <thead>
            <tr>
                <!-- <th width="25%">Tag</th> -->
                <th width="25%">On</th>
                <th width="25%">Do</th>
                <th width="45%">Value</th>
                <th width="5%"></th>
            </tr>
        </thead>
        <tbody>
            {{range .settings.Rules }}
            <tr>
                <td>{{.On}}</td>
                <td>{{.Do}}</td>
                <td>{{.Value}}</td>
                <td>
                    <button type="button" class="btn btn-primary btn-danger btn-xs">
                        <span class="glyphicon glyphicon-trash"></span>
                    </button>
                </td>
            </tr>
            {{end}}
            <tr>
                <td>
                    <select class="form-control" id="on-field"></select>
                </td>
                <td>
                    <select class="form-control" id="do-field"></select>
                </td>
                <td>
                    <textarea class="form-control" rows="2" style="resize: vertical; min-height: 33px;" id="value-field"></textarea>
                </td>
                <td>
                    <button type="button" class="btn btn-primary btn-success btn-xs">
                        <span class="glyphicon glyphicon-plus"></span>
                    </button>
                </td>
            </tr>
        </tbody>
    </table>
    </div>
        {{end}}

    <div class="form-group">
    <label for="other">Other:</label>
    <textarea name="other" class="form-control" rows="10" id="other"></textarea>
    <script>
        $('#other').val("{{.settings.Settings}}");
    </script>  
    </div>

        {{if .settings.Schema}}
    <script>
        var SCHEMA = JSON.parse("{{.settings.Schema}}");
        var ONF = $('#on-field');
        var DOF = $('#do-field');
        var VALF = $('#value-field');

        // add empty option
        newoption = document.createElement("option");
        ONF.append(newoption);

        Object.keys(SCHEMA).forEach(key =>{
            newoption = document.createElement("option");
            newoption.text = `${key}`;
            ONF.append(newoption);
        });
        ONF.change((event)=>{
            key = ONF.val();
            DOF.empty();

            // add empty option
            newoption = document.createElement("option");
            DOF.append(newoption);

            SCHEMA[key].forEach((opt) => {
                newoption = document.createElement("option");
                newoption.text = `${opt}`;
                DOF.append(newoption);
            });
        });
        DOF.change((event)=>{
            first = ONF.val();
            second = DOF.val();
            if (first && second) {
                VALF.empty();
                VALF.val(`{"${first}" : "${first.toUpperCase()}",\n  "${second}" : "${second.toUpperCase()}"}`)
            }
        });

    </script>
        {{end}}

    {{else}}
    <div class="row">
        <div class="span6">
            <div class="alert alert-danger" id="settings-error">
                Some error occurred.
            </div>
        </div>
    </div>
    {{end}}
</div>
